import{r as s,i as O,h as E,s as i,j as t}from"./index-BczRz4ky.js";import{L as j}from"./Layout-Cjs2lFUa.js";import{B as T}from"./crystal-icon-BR5-Rl_Z.js";import{I as k}from"./IncomeSourceCard-Iw41nydx.js";import{I as L}from"./IncomeSourceDialog-BpGFH5Ja.js";import{A as B,a as P,b as F,c as H,d as R,e as z,f as G,g as J}from"./alert-dialog-B9w34hCo.js";import{P as K}from"./dialog-BsWlHXv2.js";import"./progress-DmPhu3Xe.js";import"./useCurrency-Ji0yYFK2.js";import"./select-DrkzBdXl.js";import"./label-03Zcm6W0.js";import"./types-Cqx1EfL_.js";const se=()=>{const[f,p]=s.useState(new Date),{toast:n}=O(),{user:a}=E(),[v,c]=s.useState(!1),[S,l]=s.useState(!1),[y,h]=s.useState(),[g,x]=s.useState(null),[d,D]=s.useState([]),[w,A]=s.useState(!0);s.useEffect(()=>{a&&m()},[a]);const m=async()=>{try{const{data:e,error:r}=await i.from("income_sources").select("*").order("created_at",{ascending:!1});if(r)throw r;const u=(e||[]).map(o=>({id:o.id,name:o.name,color:o.color,amount:o.amount?Number(o.amount):void 0,frequency:o.frequency||void 0,receivedDate:o.received_date||void 0}));D(u)}catch(e){n({title:"Ошибка загрузки",description:e.message,variant:"destructive"})}finally{A(!1)}},C=()=>{h(void 0),c(!0)},N=e=>{h(e),c(!0)},_=async e=>{if(a)try{if(e.id){const{error:r}=await i.from("income_sources").update({name:e.name,color:e.color,amount:e.amount,frequency:e.frequency,received_date:e.receivedDate}).eq("id",e.id);if(r)throw r;n({title:"Источник обновлен",description:"Изменения успешно сохранены"})}else{const{error:r}=await i.from("income_sources").insert({user_id:a.id,name:e.name,color:e.color,amount:e.amount,frequency:e.frequency,received_date:e.receivedDate});if(r)throw r;n({title:"Источник добавлен",description:"Новый источник дохода создан"})}await m()}catch(r){n({title:"Ошибка",description:r.message,variant:"destructive"})}},q=e=>{x(e),l(!0)},b=async()=>{if(g)try{const{error:e}=await i.from("income_sources").delete().eq("id",g);if(e)throw e;n({title:"Источник удален",description:"Источник дохода успешно удален"}),await m()}catch(e){n({title:"Ошибка удаления",description:e.message,variant:"destructive"})}finally{x(null),l(!1)}},I=e=>{const r=d.find(u=>u.id===e);return{sourceId:e,totalIncome:(r==null?void 0:r.amount)||0,totalSpent:0,remaining:(r==null?void 0:r.amount)||0,debt:0}};return w?t.jsx(j,{selectedDate:f,onDateChange:p,children:t.jsx("div",{className:"text-center py-12",children:t.jsx("p",{className:"text-muted-foreground",children:"Загрузка источников дохода..."})})}):t.jsxs(j,{selectedDate:f,onDateChange:p,children:[t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-3xl font-bold",children:"Источники дохода"}),t.jsx("p",{className:"text-muted-foreground",children:"Управление источниками дохода"})]}),t.jsxs(T,{onClick:C,children:[t.jsx(K,{className:"h-4 w-4 mr-2"}),"Добавить источник"]})]}),t.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:d.map(e=>t.jsx(k,{source:e,summary:I(e.id),onEdit:N,onDelete:q,compact:!0},e.id))}),d.length===0&&t.jsx("div",{className:"text-center py-12",children:t.jsx("p",{className:"text-muted-foreground",children:"Нет источников дохода. Добавьте первый источник."})})]}),t.jsx(L,{open:v,onOpenChange:c,source:y,onSave:_}),t.jsx(B,{open:S,onOpenChange:l,children:t.jsxs(P,{children:[t.jsxs(F,{children:[t.jsx(H,{children:"Вы уверены?"}),t.jsx(R,{children:"Это действие нельзя отменить. Источник дохода будет удален навсегда."})]}),t.jsxs(z,{children:[t.jsx(G,{children:"Отмена"}),t.jsx(J,{onClick:b,children:"Удалить"})]})]})})]})};export{se as default};
