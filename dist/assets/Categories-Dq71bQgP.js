import{i as U,r as d,j as e,h as de,s as p}from"./index-BczRz4ky.js";import{L as J}from"./Layout-Cjs2lFUa.js";import{B as C}from"./crystal-icon-BR5-Rl_Z.js";import{T as me,S as M,a as P,b as z,d as H,e as N}from"./select-DrkzBdXl.js";import{C as ue}from"./CategoryCard-DkQaFMeh.js";import{D as he,a as pe,b as xe,c as fe,d as ge,P as W,e as je}from"./dialog-BsWlHXv2.js";import{L as E,I as K}from"./label-03Zcm6W0.js";import{h as ve}from"./numberInput-Di0gcIKz.js";import{o as Q,Z as Se,a as we,s as q,n as ye,e as Ce}from"./types-Cqx1EfL_.js";import{A as Ne,a as De,b as _e,c as be,d as Ie,e as Te,f as Ae,g as Ee}from"./alert-dialog-B9w34hCo.js";import"./progress-DmPhu3Xe.js";import"./useCurrency-Ji0yYFK2.js";const Ve=Q({name:q().min(1,"–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ").max(100),icon:q().min(1,"–ò–∫–æ–Ω–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞"),allocations:we(Q({incomeSourceId:q().min(1,"–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫"),allocationType:Ce(["amount","percent"]),allocationValue:ye().min(0)})).min(1,"–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫")});function ke({open:m,onOpenChange:S,category:i,incomeSources:w,onSave:V}){const{toast:D}=U(),[_,v]=d.useState(""),[b,y]=d.useState("üìÅ"),[x,f]=d.useState([]);d.useEffect(()=>{i?(v(i.name),y(i.icon),f(i.allocations||[])):(v(""),y("üìÅ"),f([]))},[i,m]);const I=()=>{f([...x,{incomeSourceId:"",allocationType:"amount",allocationValue:0}])},k=s=>{f(x.filter((l,c)=>c!==s))},g=(s,l,c)=>{const j=[...x];j[s]={...j[s],[l]:c},f(j)},O=()=>{try{const s=Ve.parse({name:_.trim(),icon:b.trim(),allocations:x.filter(l=>l.incomeSourceId).map(l=>({incomeSourceId:l.incomeSourceId,allocationType:l.allocationType,allocationValue:typeof l.allocationValue=="string"?parseFloat(l.allocationValue):l.allocationValue}))});V({id:i==null?void 0:i.id,name:s.name,icon:s.icon,allocations:s.allocations}),S(!1)}catch(s){s instanceof Se&&D({title:"–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏",description:s.errors[0].message,variant:"destructive"})}},B=["üí∞","üíµ","üí≥","üè¶","üìä","üí∏","ü§ë","üí≤","üõí","üçî","‚òï","üè†","üöó","‚ö°","üíä","üìö","üéì","üëï","üé¨","üéÆ","‚úàÔ∏è","üéÅ","üì±","üíª"];return e.jsx(he,{open:m,onOpenChange:S,children:e.jsxs(pe,{className:"sm:max-w-[500px] max-h-[90vh] overflow-y-auto",children:[e.jsxs(xe,{children:[e.jsx(fe,{children:i?"–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é":"–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é"}),e.jsx(ge,{children:i?"–ò–∑–º–µ–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤":"–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ä–∞—Å—Ö–æ–¥–æ–≤"})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(E,{htmlFor:"name",children:"–ù–∞–∑–≤–∞–Ω–∏–µ"}),e.jsx(K,{id:"name",placeholder:"–ü—Ä–æ–¥—É–∫—Ç—ã, –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç...",value:_,onChange:s=>v(s.target.value)})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(E,{children:"–ò–∫–æ–Ω–∫–∞"}),e.jsx("div",{className:"flex flex-wrap gap-2 justify-center",children:B.map(s=>e.jsx(C,{type:"button",variant:b===s?"default":"outline",className:"text-2xl h-12 w-12 p-0",onClick:()=>y(s),children:s},s))})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(E,{children:"–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ"}),e.jsxs(C,{type:"button",size:"sm",variant:"outline",onClick:I,children:[e.jsx(W,{className:"h-4 w-4 mr-1"}),"–î–æ–±–∞–≤–∏—Ç—å"]})]}),x.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"–ù–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Ö–æ–¥–∞ –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –±—é–¥–∂–µ—Ç–∞."}),x.map((s,l)=>e.jsxs("div",{className:"border rounded-lg p-3 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(E,{className:"text-sm",children:["–ò—Å—Ç–æ—á–Ω–∏–∫ ",l+1]}),e.jsx(C,{type:"button",size:"sm",variant:"ghost",onClick:()=>k(l),children:e.jsx(me,{className:"h-4 w-4"})})]}),e.jsxs(M,{value:s.incomeSourceId,onValueChange:c=>g(l,"incomeSourceId",c),children:[e.jsx(P,{children:e.jsx(z,{placeholder:"–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫"})}),e.jsx(H,{className:"bg-background z-50",children:w.map(c=>e.jsx(N,{value:c.id,children:c.name},c.id))})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs(M,{value:s.allocationType,onValueChange:c=>g(l,"allocationType",c),children:[e.jsx(P,{children:e.jsx(z,{})}),e.jsxs(H,{className:"bg-background z-50",children:[e.jsx(N,{value:"amount",children:"–°—É–º–º–∞"}),e.jsx(N,{value:"percent",children:"–ü—Ä–æ—Ü–µ–Ω—Ç"})]})]}),e.jsx(K,{inputMode:"decimal",placeholder:s.allocationType==="amount"?"5000":"30",value:s.allocationValue||"",onChange:c=>ve(c.target.value,j=>g(l,"allocationValue",j)),min:"0",max:s.allocationType==="percent"?"100":void 0})]})]},l))]})]}),e.jsxs(je,{children:[e.jsx(C,{variant:"outline",onClick:()=>S(!1),children:"–û—Ç–º–µ–Ω–∞"}),e.jsx(C,{onClick:O,children:i?"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å":"–î–æ–±–∞–≤–∏—Ç—å"})]})]})})}const Ge=()=>{const[m,S]=d.useState(new Date),{toast:i}=U(),{user:w}=de(),[V,D]=d.useState(!1),[_,v]=d.useState(!1),[b,y]=d.useState(),[x,f]=d.useState(null),[I,k]=d.useState([]),[g,O]=d.useState([]),[B,s]=d.useState([]),[l,c]=d.useState(!0),[j,X]=d.useState("name");d.useEffect(()=>{w&&F()},[w,m]);const F=async()=>{try{const{data:a,error:n}=await p.from("income_sources").select("*");if(n)throw n;const r=new Date(m.getFullYear(),m.getMonth(),1).toISOString(),t=new Date(m.getFullYear(),m.getMonth()+1,0,23,59,59).toISOString(),{data:u,error:T}=await p.from("incomes").select("source_id, amount").gte("date",r).lte("date",t);if(T)throw T;const ne=(u||[]).reduce((o,A)=>{const h=A.source_id;return h&&(o[h]=(o[h]||0)+Number(A.amount)),o},{}),R=(a||[]).map(o=>({id:o.id,name:o.name,color:o.color,amount:ne[o.id]||(o.amount?Number(o.amount):void 0),frequency:o.frequency||void 0,receivedDate:o.received_date||void 0}));console.log("Loaded income sources with amounts:",R),O(R);const{data:le,error:Y}=await p.from("categories").select("*").order("created_at",{ascending:!1});if(Y)throw Y;const{data:ie,error:Z}=await p.from("category_allocations").select("*");if(Z)throw Z;const{data:re,error:G}=await p.from("expenses").select("category_id, amount").gte("date",r).lte("date",t);if(G)throw G;s(re||[]);const ce=(le||[]).map(o=>{const A=(ie||[]).filter(h=>h.category_id===o.id).map(h=>({id:h.id,incomeSourceId:h.income_source_id,allocationType:h.allocation_type,allocationValue:Number(h.allocation_value)}));return{id:o.id,name:o.name,icon:o.icon,allocations:A,linkedSourceId:o.linked_source_id||void 0,allocationAmount:o.allocation_amount?Number(o.allocation_amount):void 0,allocationPercent:o.allocation_percent?Number(o.allocation_percent):void 0}});k(ce)}catch(a){i({title:"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏",description:a.message,variant:"destructive"})}finally{c(!1)}},$=()=>{y(void 0),D(!0)},ee=a=>{y(a),D(!0)},ae=async a=>{if(w)try{let n=a.id;if(n){const{error:r}=await p.from("categories").update({name:a.name,icon:a.icon}).eq("id",n);if(r)throw r;const{error:t}=await p.from("category_allocations").delete().eq("category_id",n);if(t)throw t}else{const{data:r,error:t}=await p.from("categories").insert({user_id:w.id,name:a.name,icon:a.icon}).select().single();if(t)throw t;n=r.id}if(a.allocations&&a.allocations.length>0){const{error:r}=await p.from("category_allocations").insert(a.allocations.map(t=>({category_id:n,income_source_id:t.incomeSourceId,allocation_type:t.allocationType,allocation_value:t.allocationValue})));if(r)throw r}i({title:a.id?"–ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞":"–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞",description:a.id?"–ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã":"–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞"}),await F()}catch(n){i({title:"–û—à–∏–±–∫–∞",description:n.message,variant:"destructive"})}},te=a=>{f(a),v(!0)},se=async()=>{if(x)try{const{error:a}=await p.from("categories").delete().eq("id",x);if(a)throw a;i({title:"–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞",description:"–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞"}),await F()}catch(a){i({title:"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è",description:a.message,variant:"destructive"})}finally{f(null),v(!1)}},L=a=>{let n=0;if(a.allocations&&a.allocations.length>0)a.allocations.forEach(t=>{const u=g.find(T=>T.id===t.incomeSourceId);t.allocationType==="amount"?n+=t.allocationValue:t.allocationType==="percent"&&(u!=null&&u.amount)&&(n+=u.amount*t.allocationValue/100)});else if(a.allocationAmount)n=a.allocationAmount;else if(a.allocationPercent&&a.linkedSourceId){const t=g.find(u=>u.id===a.linkedSourceId);t!=null&&t.amount&&(n=t.amount*a.allocationPercent/100)}const r=B.filter(t=>t.category_id===a.id).reduce((t,u)=>t+Number(u.amount),0);return{categoryId:a.id,allocated:n,spent:r,remaining:n-r}};if(l)return e.jsx(J,{selectedDate:m,onDateChange:S,children:e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-muted-foreground",children:"–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π..."})})});const oe=[...I].sort((a,n)=>{const r=L(a),t=L(n);switch(j){case"name":return a.name.localeCompare(n.name);case"spent":return t.spent-r.spent;case"remaining":return t.remaining-r.remaining;default:return 0}});return e.jsxs(J,{selectedDate:m,onDateChange:S,children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤"}),e.jsx("p",{className:"text-muted-foreground",children:"–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –∏ –±—é–¥–∂–µ—Ç–∞–º–∏"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(M,{value:j,onValueChange:a=>X(a),children:[e.jsx(P,{className:"w-full sm:w-[140px]",children:e.jsx(z,{})}),e.jsxs(H,{children:[e.jsx(N,{value:"name",children:"–ò–º—è"}),e.jsx(N,{value:"spent",children:"–¢—Ä–∞—Ç—ã"}),e.jsx(N,{value:"remaining",children:"–û—Å—Ç–∞—Ç–æ–∫"})]})]}),e.jsxs(C,{onClick:$,className:"w-full sm:w-auto",children:[e.jsx(W,{className:"h-4 w-4 mr-2"}),"–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é"]})]})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4",children:oe.map(a=>e.jsx(ue,{category:a,budget:L(a),incomeSources:g,onEdit:ee,onDelete:te},a.id))}),I.length===0&&e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-muted-foreground",children:"–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞—Å—Ö–æ–¥–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é."})})]}),e.jsx(ke,{open:V,onOpenChange:D,category:b,incomeSources:g,onSave:ae}),e.jsx(Ne,{open:_,onOpenChange:v,children:e.jsxs(De,{children:[e.jsxs(_e,{children:[e.jsx(be,{children:"–í—ã —É–≤–µ—Ä–µ–Ω—ã?"}),e.jsx(Ie,{children:"–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –ö–∞—Ç–µ–≥–æ—Ä–∏—è –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞ –Ω–∞–≤—Å–µ–≥–¥–∞."})]}),e.jsxs(Te,{children:[e.jsx(Ae,{children:"–û—Ç–º–µ–Ω–∞"}),e.jsx(Ee,{onClick:se,children:"–£–¥–∞–ª–∏—Ç—å"})]})]})})]})};export{Ge as default};
